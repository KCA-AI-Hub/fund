# 민원처리 챗봇 하이브리드 RAG 시스템 가이드

> 초보자도 이해할 수 있는 전체 구조 설명

---

## 📂 프로젝트 전체 구조

```
test_dify/
├── 📊 데이터 (data/)
│   ├── law.xlsx               # 법령 원본 (14 sheets, 1,063개) → SQLite
│   ├── faq_topic.xlsx         # FAQ 원본 (102개) → Dify 지식베이스
│   └── chatbot.db             # SQLite 데이터베이스 (법령 전용)
│
├── 🔄 데이터 변환
│   └── convert_law_to_db_sheets.py    # 법령 엑셀 → DB 변환
│
├── 🖥️ 백엔드 (Python)
│   ├── app.py                 # Flask 서버 + 하이브리드 RAG
│   └── database.py            # SQLite 법령 검색
│
├── 🎨 프론트엔드 (design/)
│   ├── index.html             # ChatGPT 스타일 UI
│   ├── script.js              # 채팅 로직
│   ├── app.js                 # 법령 편집 UI
│   └── styles.css             # 다크 테마
│
└── 📝 문서 (improve/)
    ├── strategy.md            # 상세 전략
    └── strategy_easy.md       # 이 문서
```

---

## 🎯 시스템 목적

**직원용 민원처리 챗봇**
- 직원이 민원 질문 입력 → 자동으로 FAQ와 법령 참고 → 답변 초안 생성
- 직원은 답변 확인/수정 후 민원인에게 전달

---

## 🏗️ 하이브리드 RAG 아키텍처

### 데이터 저장 전략

```
┌──────────────────────────────────────────────────┐
│            하이브리드 RAG 시스템                  │
└──────────────────────────────────────────────────┘

FAQ (102개)
    ↓
Dify 지식베이스
    - 시맨틱 검색 (자연어 이해)
    - Reranking (정확도 향상)
    - 사용자 질문 → 유사 FAQ 찾기

법령 (1,063개)
    ↓
SQLite 데이터베이스
    - SQL 키워드 검색
    - policy_anchor 기반 정확한 매칭
    - 빠른 검색 속도
```

### 왜 이렇게 나눴나요?

| 데이터 | 저장소 | 이유 |
|--------|--------|------|
| **FAQ** | Dify | 사용자가 다양한 표현으로 질문 → 시맨틱 검색 필요 |
| **법령** | SQLite | policy_anchor가 정확한 키워드 제공 → 키워드 검색으로 충분 |

---

## 🔄 질문 → 답변 전체 흐름

```
┌─────────────────────────────────────────────┐
│  사용자 질문: "사업비 교부는 어떻게 받나요?" │
└─────────────────────────────────────────────┘
    ↓
[브라우저] script.js
    ↓ POST /api/chat
    ↓
[Flask 서버] app.py
    ↓
┌──────────────────────────────────────────┐
│ STEP 1: Dify API - FAQ 검색              │
│ - 시맨틱 검색으로 유사 FAQ 찾기           │
│ - Reranking으로 Top 3 선택               │
│ → 결과: FAQ-사업비-0005 (score: 0.89)   │
└──────────────────────────────────────────┘
    ↓
┌──────────────────────────────────────────┐
│ STEP 2: faq_id 추출                     │
│ → "FAQ-사업비-0005"                     │
└──────────────────────────────────────────┘
    ↓
┌──────────────────────────────────────────┐
│ STEP 3: policy_anchor 매핑 (로컬)       │
│ - faq_topic.xlsx 파일에서 찾기           │
│ → "기금운영지침 제10조; 사업비 교부"     │
└──────────────────────────────────────────┘
    ↓
┌──────────────────────────────────────────┐
│ STEP 4: SQLite - 법령 검색               │
│ - policy_anchor로 키워드 검색            │
│ - database.search_laws() 호출            │
│ → 결과: [법령1, 법령2]                   │
└──────────────────────────────────────────┘
    ↓
┌──────────────────────────────────────────┐
│ STEP 5: OpenAI GPT - 답변 생성           │
│ - Context: FAQ 답변 + 법령 전체 텍스트   │
│ - GPT-4o-mini 호출                       │
│ → "사업비 교부는 협약 체결 후..."       │
└──────────────────────────────────────────┘
    ↓
┌──────────────────────────────────────────┐
│ STEP 6: 응답 반환 (JSON)                 │
│ {                                         │
│   message: "GPT 답변",                   │
│   suggested_answer: "HTML 포맷 답변",    │
│   related_laws: [법령1, 법령2]          │
│ }                                         │
└──────────────────────────────────────────┘
    ↓
[브라우저] script.js
    - 채팅 영역: GPT 답변 표시
    - 오른쪽 패널: 관련 법령 5개 표시
    ↓
[직원] 답변 확인 후 수정/복사
```

---

## 📊 데이터 구조

### 1. Dify 지식베이스 (FAQ 102개)

```
┌────────────────┬─────────────────────────────────┐
│ faq_id         │ "FAQ-사업비-0005"               │
│ question       │ "사업비 교부는 어떻게 받나요?"   │
│ answer_text    │ "협약 체결 후..."                │
│ policy_anchor  │ "기금운영지침 제10조"            │
│ tag            │ "사업비,교부"                    │
└────────────────┴─────────────────────────────────┘

특징:
- Dify가 자동으로 임베딩 생성
- 시맨틱 검색 지원 (유사 의미 인식)
- Reranking으로 정확도 향상
```

### 2. SQLite 데이터베이스 (법령 1,063개)

```sql
laws 테이블
┌──────────────┬─────────────────────────────┐
│ law_id       │ "중앙기관_제10조_제1항"      │
│ law_title    │ "기금운영지침"               │
│ sheet_name   │ "중앙기관 시행지침서"        │
│ article_num  │ "제10조"                     │
│ article_title│ "사업비 교부"                │
│ paragraph_num│ 1.0                          │
│ paragraph_   │ "사업비는 협약 체결 후..."   │
│   content    │                              │
│ full_text    │ "제10조 (사업비 교부) ..."   │
│ tag          │ "사업비,교부,협약"           │
└──────────────┴─────────────────────────────┘

특징:
- 3단계 구조: Sheet → 조(Article) → 항(Paragraph)
- LIKE 검색으로 빠른 키워드 매칭
- 인덱스로 검색 속도 최적화
```

---

## 🔍 핵심 기능 설명

### 1. Dify Reranking이란?

```
사용자 질문: "사업비 받는 방법은?"
    ↓
[1단계] 임베딩 검색
    → 100개 후보 FAQ 찾기
    ↓
[2단계] Reranking 모델
    → 관련도 높은 순으로 재정렬
    ↓
[3단계] Top 3 선택
    → FAQ-사업비-0005 (0.89)
    → FAQ-교부금-0012 (0.76)
    → FAQ-협약-0003 (0.65)
```

**장점**: 단순 키워드 매칭보다 정확
**예**: "받는 방법"과 "교부 절차"를 같은 의미로 인식

### 2. policy_anchor란?

```
FAQ-사업비-0005
    ↓ policy_anchor 연결
    ↓
"기금운영지침 제10조; 사업비 교부"
    ↓ SQLite 검색
    ↓
법령: 기금운영지침 제10조 (사업비 교부)
      → 전체 조항 내용 반환
```

**역할**: FAQ와 법령을 연결하는 다리

### 3. GPT 컨텍스트란?

```python
# GPT에게 전달하는 정보
context = """
[참고 FAQ]
질문: 사업비 교부는 어떻게 받나요?
답변: 협약 체결 후 신청서를 제출하면...

[참고 법령 1]
기금운영지침 제10조 (사업비 교부)
제1항: 사업비는 협약 체결 후...
(전체 텍스트)

[참고 법령 2]
사업비 교부 절차
제1항: 교부 신청은...
(전체 텍스트)
"""

# GPT에게 질문
user_question = "사업비 교부는 어떻게 받나요?"

# GPT 답변
→ context를 참고하여 정확한 답변 생성
```

**장점**: GPT가 추측이 아닌 실제 FAQ와 법령을 참고

---

## 🔌 주요 파일 역할

### app.py (Flask 서버)

```python
하이브리드 RAG 구현
├── call_dify_knowledge()         # Dify API 호출 (FAQ 검색)
├── extract_faq_id_from_content() # faq_id 추출
├── get_policy_anchor()           # 법령 참조 찾기
├── generate_answer_with_context()# GPT 답변 생성
└── /api/chat                     # 메인 API 엔드포인트
```

### database.py (SQLite 쿼리)

```python
법령 검색 전용
├── search_laws(keyword)          # 키워드로 법령 검색
├── get_sheet_list()              # 14개 Sheet 목록
├── get_articles_by_sheet()       # Sheet별 조항 목록
└── get_paragraphs_by_article()   # 조항별 항 목록
```

### script.js (프론트엔드)

```javascript
채팅 UI 관리
├── sendMessage()                 # 사용자 메시지 전송
├── generateActualAnswer()        # API 호출
├── addMessage()                  # 메시지 화면 추가
└── updateLawContent()            # 관련 법령 표시
```

---

## 🚀 실행 방법

### 1. 초기 설정

```bash
# 패키지 설치
uv add pandas openpyxl flask openai python-dotenv requests

# 법령 데이터 변환
uv run python convert_law_to_db_sheets.py
# → chatbot.db 생성 (1,063개 법령)

# FAQ 업로드 (Dify 콘솔)
# faq_topic.xlsx를 Dify 지식베이스에 업로드
```

### 2. 환경 변수 설정

```.env
OPENAI_API_KEY=sk-proj-...
DIFY_API_URL=http://112.173.179.199:5001/v1
DIFY_API_KEY=dataset-...
DIFY_DATASET_ID=...
AI_MODE=dify
```

### 3. 서버 실행

```bash
python app.py
```

### 4. 브라우저 접속

```
http://localhost:5000
```

---

## 🎨 UI 구성

```
┌─────────────────────────────────────────────────┐
│                   브라우저 화면                  │
├──────────┬────────────────────┬─────────────────┤
│          │                    │                 │
│ 사이드바  │    채팅 영역        │  오른쪽 패널     │
│          │                    │                 │
│ [새채팅]  │ [사용자]           │ 📋 답변 추천     │
│          │ 질문...            │                 │
│ 채팅1    │                    │ <HTML 답변>     │
│ 채팅2    │ [챗봇]             │                 │
│ 채팅3    │ 답변...            │ ⚖️ 관련 법령     │
│          │                    │                 │
│          │ ─────────────      │ [법령1]         │
│          │                    │ [법령2]         │
│          │ [입력창]           │ [법령3]         │
│          │                    │                 │
└──────────┴────────────────────┴─────────────────┘
```

---

## 📝 데이터 흐름 예시

### 예시 질문: "사업비 교부는 어떻게 받나요?"

**1. Dify FAQ 검색**
```json
{
  "score": 0.89,
  "faq_id": "FAQ-사업비-0005",
  "content": "질문: 사업비 교부는... 답변: 협약 체결 후..."
}
```

**2. policy_anchor 찾기**
```
"기금운영지침 제10조; 사업비 교부"
```

**3. SQLite 법령 검색**
```sql
SELECT * FROM laws
WHERE full_text LIKE '%기금운영지침 제10조%'
   OR full_text LIKE '%사업비 교부%'
```

**4. GPT 컨텍스트**
```
[참고 FAQ]
질문: 사업비 교부는...
답변: 협약 체결 후...

[참고 법령]
기금운영지침 제10조...
```

**5. GPT 답변**
```
"사업비 교부는 협약 체결 후 신청서를 제출하면 검토 후 입금됩니다..."
```

**6. 화면 표시**
- 채팅 영역: GPT 답변
- 오른쪽 패널: 관련 법령 5개 리스트

---

## 💡 이 시스템의 장점

### 1. 최적화된 검색
- **FAQ**: 자연어 이해 (Dify Reranking)
  - "교부 받는 법" → "사업비 교부 절차" 매칭
- **법령**: 정확한 키워드 매칭 (SQLite)
  - "기금운영지침 제10조" → 정확히 찾기

### 2. 빠른 응답 속도
- Dify API 호출 1번만 (FAQ)
- 법령은 로컬 SQLite (빠름)
- 총 1-2초 내 답변 생성

### 3. 비용 효율
- Dify: FAQ만 검색 (용량 절약)
- SQLite: 무료, 무제한
- OpenAI: GPT-4o-mini 사용 (저렴)

### 4. 정확한 답변
- policy_anchor로 FAQ-법령 연결
- GPT가 실제 문서 참고하여 답변
- 환각(hallucination) 최소화

---

## 🔧 주요 용어 설명

| 용어 | 설명 |
|------|------|
| **RAG** | Retrieval-Augmented Generation (검색 증강 생성) |
| **시맨틱 검색** | 의미 기반 검색 (키워드가 아닌 의미로 찾기) |
| **Reranking** | 검색 결과를 관련도 순으로 재정렬 |
| **임베딩** | 텍스트를 수치 벡터로 변환 (유사도 계산용) |
| **policy_anchor** | FAQ와 법령을 연결하는 참조 정보 |
| **컨텍스트** | GPT에게 제공하는 참고 정보 |

---

## 🎯 요약: 3줄 정리

1. **FAQ는 Dify (시맨틱 검색 + Reranking), 법령은 SQLite (키워드 검색)**
2. **Flask 서버가 Dify API와 SQLite를 검색하고 GPT로 답변 생성**
3. **브라우저에서 질문하면 1-2초 내 답변과 관련 법령 표시**

---

## 📚 자주 묻는 질문

**Q1. 왜 FAQ와 법령을 다른 곳에 저장하나요?**
A. FAQ는 자연어 이해가 필요 (Dify), 법령은 정확한 참조가 필요 (SQLite)

**Q2. Reranking이 없으면 어떻게 되나요?**
A. 단순 키워드 매칭만 되어 정확도 떨어짐. 예: "교부 방법" 질문에 "교부금" FAQ만 찾아질 수 있음.

**Q3. policy_anchor가 없으면?**
A. FAQ만 참고하여 답변 생성. 관련 법령은 키워드 검색으로만 찾음.

**Q4. GPT가 없는 정보를 만들어내지 않나요?**
A. 컨텍스트에 실제 FAQ와 법령을 제공하여 환각 최소화. 프롬프트에 "참고 자료에 없는 내용은 추측하지 말라"고 명시.

**Q5. 서버 재시작하면 데이터가 사라지나요?**
A. 아니요. FAQ는 Dify에, 법령은 SQLite에 영구 저장됨.

---

**작성일**: 2025-11-26
**버전**: 2.0 (하이브리드 RAG)
